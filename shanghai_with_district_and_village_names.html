import folium
import requests
import json

# åˆ›å»ºåœ°å›¾ï¼ˆä½¿ç”¨ç®€æ´åº•å›¾ï¼‰
m = folium.Map(
    location=[31.2304, 121.4737],
    zoom_start=10,
    tiles="CartoDB Positron",  # ç®€æ´æ— å¹²æ‰°
    attr="Â© OpenStreetMap contributors"
)

# ä» GitHub åŠ è½½ä¸Šæµ·åŒºå¿çº§ GeoJSON
url = "http://localhost:8000/%E4%B8%8A%E6%B5%B7.json"

try:
    response = requests.get(url)
    shanghai_geojson = response.json()

    # å…ˆç»˜åˆ¶åŒºå¿è¾¹ç•Œ
    folium.GeoJson(
        shanghai_geojson,
        name="ä¸Šæµ·åŒºå¿è¾¹ç•Œ",
        style_function=lambda feature: {
            'fillColor': '#ffffff00',  # é€æ˜å¡«å……
            'color': '#3388ff',
            'weight': 2,
            'fillOpacity': 0.1
        }
    ).add_to(m)

    # âœ… åœ¨æ¯ä¸ªåŒºå¿ä¸­å¿ƒæ·»åŠ æ°¸ä¹…æ˜¾ç¤ºçš„åŒºåæ ‡ç­¾
    for feature in shanghai_geojson['features']:
        props = feature['properties']
        district_name = props.get('name', 'æœªçŸ¥')

        # è·å–åŒºå¿å‡ ä½•ä¸­å¿ƒï¼ˆè¿‘ä¼¼ï¼‰
        geom = feature['geometry']
        if geom['type'] == 'Polygon':
            coords = geom['coordinates'][0]
        elif geom['type'] == 'MultiPolygon':
            coords = geom['coordinates'][0][0]
        else:
            continue

        # è®¡ç®—ä¸­å¿ƒç‚¹ï¼ˆç®€å•å–å¹³å‡ï¼‰
        lons = [p[0] for p in coords]
        lats = [p[1] for p in coords]
        center_lon = sum(lons) / len(lons)
        center_lat = sum(lats) / len(lats)

        # æ·»åŠ æ°¸ä¹…æ–‡æœ¬æ ‡ç­¾ï¼ˆæ— å›¾æ ‡ï¼‰
        folium.Marker(
            location=[center_lat, center_lon],
            icon=folium.DivIcon(
                html=f'<div style="font-size: 10pt; font-weight: bold; color: #333;">{district_name}</div>',
                icon_anchor=(0, 0)
            ),
            tooltip=district_name  # é¼ æ ‡æ‚¬åœä¹Ÿæ˜¾ç¤º
        ).add_to(m)

except Exception as e:
    print("âš ï¸ æ— æ³•åŠ è½½GeoJSONæ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚é”™è¯¯ï¼š", e)

# âœ… ä½ å»è¿‡çš„æ‘å­ï¼ˆæ°¸ä¹…æ˜¾ç¤ºåç§° + æ ‡è®°ï¼‰
visited_villages = [
    {"name": "æœˆç‹®æ‘", "lat": 31.449401017793043, "lon": 121.40776099308742},
    {"name": "æ¸”æ²¥æ‘", "lat": 30.978186481779186, "lon": 121.39500863065729},
    {"name": "æ½˜å«æ‘", "lat": 30.876454658483862, "lon": 121.39732662017737},
    {"name": "æµ¦ç§€æ‘", "lat": 30.982717027451,  "lon": 121.40377436627526},
    {"name": "å´æˆ¿æ‘", "lat": 30.892506017614213, "lon": 121.53504702759982},
    {"name": "åˆä¸­æ‘", "lat": 31.739835066945883, "lon": 121.35758294345864},
    {"name": "æ½˜çŸ³æ‘", "lat": 31.419508301071424, "lon": 121.63867906498342},
    {"name": "ç€›ä¸œæ‘", "lat": 31.464467751121507, "lon": 121.84474198035542},
    {"name": "é•¿æº‡æ‘", "lat": 30.965737866195948, "lon": 121.28692984246975},
    {"name": "è”ä¸€æ‘", "lat": 31.480710265422793, "lon": 121.30784088293922},
    {"name": "ä¸­å…´æ‘", "lat": 30.77463308802813, "lon": 121.34029554825031},
    {"name": "èµµå®¶æ‘", "lat": 31.249686559169167, "lon": 121.26189655694816},
    {"name": "ä¸œå¤æ‘", "lat": 30.97455079892934, "lon": 121.13664681074845},
    {"name": "è²æ¹–æ‘", "lat": 31.062126519741472, "lon": 121.00766298011189},
    {"name": "äº•äº­æ‘", "lat": 31.5887305507916, "lon": 121.49376574232892},
    {"name": "åŒ—ç®¡æ‘", "lat": 31.335324613332354, "lon": 121.32308031889819},
    {"name": "æ°´åº“æ‘", "lat": 30.82588239223915, "lon": 121.39745781065935},
    {"name": "æ·®æµ·æ‘", "lat": 31.238886873594392, "lon": 121.2049055855767},
    {"name": "æ±Ÿç§‹æ‘", "lat": 31.098150357834804, "lon": 121.1757057103043},
    {"name": "å¤§é»„æ‘", "lat": 31.359164371881203, "lon": 121.4334034723598},
    {"name": "ä¸œåæ‘", "lat": 30.962590743239772, "lon": 121.03790489539675},
    {"name": "çº¢æ——æ‘", "lat": 31.235599491597164, "lon": 121.10087323418234},
    {"name": "è¿æ°‘æ‘", "lat": 31.087050372321624, "lon": 121.6883878108163},
    {"name": "ç¯å¡”æ‘", "lat": 31.43697817812914, "lon": 121.17409687982011},
    {"name": "å‰å«æ‘", "lat": 31.718059735661807, "lon": 121.51191364188954},
    {"name": "é’±å¿ æ‘", "lat": 30.881896753638873, "lon": 121.54691733641157},
    {"name": "ç™½æ²™æ‘", "lat": 30.945381614301912, "lon": 121.52887740331796},
    {"name": "é‡‘æ²™å˜´æ¸”æ‘", "lat": 30.79148369006597, "lon": 121.42844397945164},
    {"name": "å½­æµ¦æ–°æ‘", "lat": 31.313799079624165, "lon": 121.44641323422962},
    {"name": "é•¿æ±Ÿæ‘", "lat": 31.050259118825508, "lon": 121.80063396424126},
    {"name": "æµ·æ²ˆæ‘", "lat": 31.026567548938285, "lon": 121.7993357419879},
    {"name": "ç»¿æ¸¯æ‘", "lat": 31.750058273755467, "lon": 121.22230952476686},
    {"name": "é»„æ¡¥æ‘", "lat": 30.94599550050562, "lon": 121.1737267419393},
    {"name": "é’±æ½˜æ‘", "lat": 31.43303537160786, "lon": 121.40390901123544},
]

import math

def distance(lat1, lon1, lat2, lon2):
    """è®¡ç®—ä¸¤ä¸ªç»çº¬åº¦ç‚¹ä¹‹é—´çš„è¿‘ä¼¼è·ç¦»ï¼ˆå•ä½ï¼šåº¦ï¼Œéç²¾ç¡®ç±³ï¼Œä½†å¤Ÿç”¨ï¼‰"""
    return math.sqrt((lat1 - lat2)**2 + (lon1 - lon2)**2)

# é˜²é‡å å‚æ•°
MIN_DISTANCE = 0.003  # åˆ¤å®šâ€œé™„è¿‘â€çš„é˜ˆå€¼ï¼ˆçº¦300ç±³ï¼‰
OFFSET = 0.004        # åç§»é‡

for i, village in enumerate(visited_villages):
    lat, lon = village["lat"], village["lon"]

    # æ ‡è®°ç‚¹ï¼ˆå›¾æ ‡ï¼‰
    folium.Marker(
        location=[lat, lon],
        popup=village["name"],
        icon=folium.Icon(color="red", icon="home", prefix="fa")
    ).add_to(m)

    # æ£€æŸ¥é™„è¿‘æ˜¯å¦æœ‰å…¶ä»–æ‘å­
    nearby = False
    for j, other in enumerate(visited_villages):
        if i == j:
            continue
        other_lat, other_lon = other["lat"], other["lon"]
        if distance(lat, lon, other_lat, other_lon) < MIN_DISTANCE:
            nearby = True
            break

    # âœ… æ™ºèƒ½é€‰æ‹©æ˜¾ç¤ºä½ç½®ï¼šä¼˜å…ˆå³ä¾§ â†’ å¦‚æœé™„è¿‘æœ‰ â†’ æ”¹ç”¨ä¸Šæ–¹ â†’ å†æœ‰ â†’ å·¦ä¾§ â†’ å†æœ‰ â†’ ä¸‹æ–¹
    if not nearby:
        offset_lat, offset_lon = 0, OFFSET  # å³ä¾§
    else:
        # å°è¯•å››ä¸ªæ–¹å‘ï¼Œæ‰¾ä¸€ä¸ªâ€œæœ€ä¸æ‹¥æŒ¤â€çš„æ–¹å‘
        directions = [
            (0, OFFSET),      # å³
            (OFFSET, 0),      # ä¸Š
            (0, -OFFSET),     # å·¦
            (-OFFSET, 0),     # ä¸‹
        ]
        best_dir = (0, OFFSET)  # é»˜è®¤å³ä¾§
        min_conflict = float('inf')

        for dlat, dlon in directions:
            test_lat, test_lon = lat + dlat, lon + dlon
            conflicts = 0
            for j, other in enumerate(visited_villages):
                if i == j:
                    continue
                other_lat, other_lon = other["lat"], other["lon"]
                # æ£€æŸ¥è¿™ä¸ªæµ‹è¯•ä½ç½®æ˜¯å¦å’Œåˆ«çš„æ‘åä½ç½®å¤ªè¿‘
                if distance(test_lat, test_lon, other_lat, other_lon) < MIN_DISTANCE:
                    conflicts += 1
            if conflicts < min_conflict:
                min_conflict = conflicts
                best_dir = (dlat, dlon)

        offset_lat, offset_lon = best_dir

    folium.Marker(
        location=[lat + offset_lat, lon + offset_lon],
        icon=folium.DivIcon(
            html=f'''
            <div style="
                font-size: 9pt;
                font-weight: bold;
                color: #d32f2f;
                white-space: nowrap;
                background: rgba(255,255,255,0.8);
                padding: 2px 4px;
                border-radius: 3px;
                border: 1px solid #ddd;
                z-index: 1000;  /* ğŸ‘ˆ å…³é”®ï¼è®©æ–‡å­—æ˜¾ç¤ºåœ¨å›¾æ ‡ä¸Šæ–¹ */
                position: relative; /* ğŸ‘ˆ é…åˆ z-index ç”Ÿæ•ˆ */
            ">{village["name"]}</div>
            ''',
            icon_anchor=(0, 6)
        )
    ).add_to(m)

# å¯é€‰ï¼šæ·»åŠ å›¾å±‚æ§åˆ¶
folium.LayerControl().add_to(m)

# ä¿å­˜
m.save("shanghai_with_district_and_village_names.html")
print("âœ… åœ°å›¾å·²ç”Ÿæˆï¼šshanghai_with_district_and_village_names.html â€”â€” è¯·ç”¨æµè§ˆå™¨æ‰“å¼€æŸ¥çœ‹")
