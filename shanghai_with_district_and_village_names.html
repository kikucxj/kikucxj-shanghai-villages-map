import folium
import requests
import json

# 创建地图（使用简洁底图）
m = folium.Map(
    location=[31.2304, 121.4737],
    zoom_start=10,
    tiles="CartoDB Positron",  # 简洁无干扰
    attr="© OpenStreetMap contributors"
)

# 从 GitHub 加载上海区县级 GeoJSON
url = "http://localhost:8000/%E4%B8%8A%E6%B5%B7.json"

try:
    response = requests.get(url)
    shanghai_geojson = response.json()

    # 先绘制区县边界
    folium.GeoJson(
        shanghai_geojson,
        name="上海区县边界",
        style_function=lambda feature: {
            'fillColor': '#ffffff00',  # 透明填充
            'color': '#3388ff',
            'weight': 2,
            'fillOpacity': 0.1
        }
    ).add_to(m)

    # ✅ 在每个区县中心添加永久显示的区名标签
    for feature in shanghai_geojson['features']:
        props = feature['properties']
        district_name = props.get('name', '未知')

        # 获取区县几何中心（近似）
        geom = feature['geometry']
        if geom['type'] == 'Polygon':
            coords = geom['coordinates'][0]
        elif geom['type'] == 'MultiPolygon':
            coords = geom['coordinates'][0][0]
        else:
            continue

        # 计算中心点（简单取平均）
        lons = [p[0] for p in coords]
        lats = [p[1] for p in coords]
        center_lon = sum(lons) / len(lons)
        center_lat = sum(lats) / len(lats)

        # 添加永久文本标签（无图标）
        folium.Marker(
            location=[center_lat, center_lon],
            icon=folium.DivIcon(
                html=f'<div style="font-size: 10pt; font-weight: bold; color: #333;">{district_name}</div>',
                icon_anchor=(0, 0)
            ),
            tooltip=district_name  # 鼠标悬停也显示
        ).add_to(m)

except Exception as e:
    print("⚠️ 无法加载GeoJSON数据，请检查网络。错误：", e)

# ✅ 你去过的村子（永久显示名称 + 标记）
visited_villages = [
    {"name": "月狮村", "lat": 31.449401017793043, "lon": 121.40776099308742},
    {"name": "渔沥村", "lat": 30.978186481779186, "lon": 121.39500863065729},
    {"name": "潘垫村", "lat": 30.876454658483862, "lon": 121.39732662017737},
    {"name": "浦秀村", "lat": 30.982717027451,  "lon": 121.40377436627526},
    {"name": "吴房村", "lat": 30.892506017614213, "lon": 121.53504702759982},
    {"name": "合中村", "lat": 31.739835066945883, "lon": 121.35758294345864},
    {"name": "潘石村", "lat": 31.419508301071424, "lon": 121.63867906498342},
    {"name": "瀛东村", "lat": 31.464467751121507, "lon": 121.84474198035542},
    {"name": "长溇村", "lat": 30.965737866195948, "lon": 121.28692984246975},
    {"name": "联一村", "lat": 31.480710265422793, "lon": 121.30784088293922},
    {"name": "中兴村", "lat": 30.77463308802813, "lon": 121.34029554825031},
    {"name": "赵家村", "lat": 31.249686559169167, "lon": 121.26189655694816},
    {"name": "东夏村", "lat": 30.97455079892934, "lon": 121.13664681074845},
    {"name": "莲湖村", "lat": 31.062126519741472, "lon": 121.00766298011189},
    {"name": "井亭村", "lat": 31.5887305507916, "lon": 121.49376574232892},
    {"name": "北管村", "lat": 31.335324613332354, "lon": 121.32308031889819},
    {"name": "水库村", "lat": 30.82588239223915, "lon": 121.39745781065935},
    {"name": "淮海村", "lat": 31.238886873594392, "lon": 121.2049055855767},
    {"name": "江秋村", "lat": 31.098150357834804, "lon": 121.1757057103043},
    {"name": "大黄村", "lat": 31.359164371881203, "lon": 121.4334034723598},
    {"name": "东厍村", "lat": 30.962590743239772, "lon": 121.03790489539675},
    {"name": "红旗村", "lat": 31.235599491597164, "lon": 121.10087323418234},
    {"name": "连民村", "lat": 31.087050372321624, "lon": 121.6883878108163},
    {"name": "灯塔村", "lat": 31.43697817812914, "lon": 121.17409687982011},
    {"name": "前卫村", "lat": 31.718059735661807, "lon": 121.51191364188954},
    {"name": "钱忠村", "lat": 30.881896753638873, "lon": 121.54691733641157},
    {"name": "白沙村", "lat": 30.945381614301912, "lon": 121.52887740331796},
    {"name": "金沙嘴渔村", "lat": 30.79148369006597, "lon": 121.42844397945164},
    {"name": "彭浦新村", "lat": 31.313799079624165, "lon": 121.44641323422962},
    {"name": "长江村", "lat": 31.050259118825508, "lon": 121.80063396424126},
    {"name": "海沈村", "lat": 31.026567548938285, "lon": 121.7993357419879},
    {"name": "绿港村", "lat": 31.750058273755467, "lon": 121.22230952476686},
    {"name": "黄桥村", "lat": 30.94599550050562, "lon": 121.1737267419393},
    {"name": "钱潘村", "lat": 31.43303537160786, "lon": 121.40390901123544},
]

import math

def distance(lat1, lon1, lat2, lon2):
    """计算两个经纬度点之间的近似距离（单位：度，非精确米，但够用）"""
    return math.sqrt((lat1 - lat2)**2 + (lon1 - lon2)**2)

# 防重叠参数
MIN_DISTANCE = 0.003  # 判定“附近”的阈值（约300米）
OFFSET = 0.004        # 偏移量

for i, village in enumerate(visited_villages):
    lat, lon = village["lat"], village["lon"]

    # 标记点（图标）
    folium.Marker(
        location=[lat, lon],
        popup=village["name"],
        icon=folium.Icon(color="red", icon="home", prefix="fa")
    ).add_to(m)

    # 检查附近是否有其他村子
    nearby = False
    for j, other in enumerate(visited_villages):
        if i == j:
            continue
        other_lat, other_lon = other["lat"], other["lon"]
        if distance(lat, lon, other_lat, other_lon) < MIN_DISTANCE:
            nearby = True
            break

    # ✅ 智能选择显示位置：优先右侧 → 如果附近有 → 改用上方 → 再有 → 左侧 → 再有 → 下方
    if not nearby:
        offset_lat, offset_lon = 0, OFFSET  # 右侧
    else:
        # 尝试四个方向，找一个“最不拥挤”的方向
        directions = [
            (0, OFFSET),      # 右
            (OFFSET, 0),      # 上
            (0, -OFFSET),     # 左
            (-OFFSET, 0),     # 下
        ]
        best_dir = (0, OFFSET)  # 默认右侧
        min_conflict = float('inf')

        for dlat, dlon in directions:
            test_lat, test_lon = lat + dlat, lon + dlon
            conflicts = 0
            for j, other in enumerate(visited_villages):
                if i == j:
                    continue
                other_lat, other_lon = other["lat"], other["lon"]
                # 检查这个测试位置是否和别的村名位置太近
                if distance(test_lat, test_lon, other_lat, other_lon) < MIN_DISTANCE:
                    conflicts += 1
            if conflicts < min_conflict:
                min_conflict = conflicts
                best_dir = (dlat, dlon)

        offset_lat, offset_lon = best_dir

    folium.Marker(
        location=[lat + offset_lat, lon + offset_lon],
        icon=folium.DivIcon(
            html=f'''
            <div style="
                font-size: 9pt;
                font-weight: bold;
                color: #d32f2f;
                white-space: nowrap;
                background: rgba(255,255,255,0.8);
                padding: 2px 4px;
                border-radius: 3px;
                border: 1px solid #ddd;
                z-index: 1000;  /* 👈 关键！让文字显示在图标上方 */
                position: relative; /* 👈 配合 z-index 生效 */
            ">{village["name"]}</div>
            ''',
            icon_anchor=(0, 6)
        )
    ).add_to(m)

# 可选：添加图层控制
folium.LayerControl().add_to(m)

# 保存
m.save("shanghai_with_district_and_village_names.html")
print("✅ 地图已生成：shanghai_with_district_and_village_names.html —— 请用浏览器打开查看")
